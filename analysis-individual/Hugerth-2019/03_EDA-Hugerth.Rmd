---
title: "Hugerth2020_DataAnalysis"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r, include=FALSE}
knitr::opts_chunk$set(fig.width = 15, fig.height = 5, warning=FALSE, message=FALSE,
                      root.dir = "~/Projects/IBS_Meta-analysis_16S/analysis-individual/Hugerth-2020/")
```



############
## IMPORT ##
############

### 1. Librairies

```{r library-import}
library(phyloseq) # for phyloseq object
library(ggplot2)
library(cowplot)
library(tidyverse)
library("plotly") # plot 3D
library("microbiome") # for centered log-ratio
library("coda") # Aitchison distance
library("coda.base") # Aitchison distance
library("vegan") # NMDS
library(pheatmap) # for heatmap
```

### 2. Data

```{r import-data}
# Set path
path <- "~/Projects/IBS_Meta-analysis_16S"

# Import phyloseq object
physeq.hugerth <- readRDS(file.path(path, "phyloseq-objects/physeq_hugerth.rds"))

# Sanity check
physeq.hugerth
```


Phylogenetic tree was computed with the package `phangorn`, and the script was run on a cluster. Let's check we have correctly generated a phylogenetic tree.

```{r plot-tree, fig.height = 6, fig.width = 10}
# Look at the tree
plot_tree(physeq.hugerth, color = "host_disease", ladderize="left")
```



```{r import-for-html, echo = FALSE}
#__________________________________________________________________________
#____________ THIS IS ONLY FOR (quicker) PDF/HTML OUTPUT __________________
#__________________________________________________________________________

# Import phyloseq objects for computing distances
physeq.rel <- readRDS(file.path(path, "data/analysis-individual/Hugerth-2020/02_EDA-Hugerth/physeq_relative.rds"))
physeq.clr <- readRDS(file.path(path, "data/analysis-individual/Hugerth-2020/02_EDA-Hugerth/physeq_clr.rds"))
physeq.CSN <- readRDS(file.path(path, "data/analysis-individual/Hugerth-2020/02_EDA-Hugerth/physeq_CSN.rds"))
physeq.NZcomp <- readRDS(file.path(path, "data/analysis-individual/Hugerth-2020/02_EDA-Hugerth/physeq_NZcomp.rds"))
```




##################
## DEMOGRAPHICS ##
##################

This dataset has several covariates (gender, age, bmi, sample_storage_duration). We will check whether there is the same distribution of these covariates between healthy and IBS patients.

```{r demographics-stats}
# Number of individuals in each group (keeping just 1 sample per individual)
metadata <- data.frame(sample_data(physeq.hugerth)) %>%
  select(host_disease, host_bmi, host_age, host_sex, host_psy, host_ID) %>%
  group_by(host_ID) %>%
  summarise_all(first)
  
metadata %>%
  count(host_disease)

# Age
metadata %>%
  group_by(host_disease) %>%
  summarize(mean_age=mean(host_age), sd_age=sd(host_age))
wilcox.test(metadata[metadata$host_disease == "IBS", ]$host_age,
            metadata[metadata$host_disease == "Healthy", ]$host_age) # p=0.23

# Gender
metadata %>%
  count(host_disease, host_sex)
chisq.test(data.frame("Female" = c(164,53),
                      "Male" = c(123,32))) # p=0.5

# BMI
metadata %>%
  group_by(host_disease) %>%
  summarize(mean_bmi=mean(na.omit(host_bmi)), sd_bmi=sd(na.omit(host_bmi)))
wilcox.test(metadata[metadata$host_disease == "IBS",]$host_bmi,
            metadata[metadata$host_disease == "Healthy", ]$host_bmi) # 0.07


# Sample storage duration (take into account all samples per individual)
data.frame(sample_data(physeq.hugerth)) %>%
  group_by(host_disease) %>%
  summarize(mean_storage_duration = mean(sample_storage_duration),
            sd = sd(sample_storage_duration))
wilcox.test(sample_data(physeq.hugerth)[sample_data(physeq.hugerth)$host_disease == "IBS", ]$sample_storage_duration,
            sample_data(physeq.hugerth)[sample_data(physeq.hugerth)$host_disease == "Healthy", ]$sample_storage_duration) # p=0.07
```




################
## ABUNDANCES ##
################

### 1. Absolute abundances

```{r plot-absolute-abundance, fig.width=10, fig.height = 5}
# Plot Phylum
plot_bar(physeq.hugerth, fill = "Phylum") + facet_wrap("host_disease", scales="free") +
  theme(axis.text.x = element_text(size = 5))+
  labs(x = "Samples", y = "Absolute abundance", title = "Hugerth dataset (2020)") +
  ylim(0,200000)

# Plot Class
plot_bar(physeq.hugerth, fill = "Class")+ facet_wrap("host_disease", scales="free") +
  theme(axis.text.x = element_text(size = 5))+
  labs(x = "Samples", y = "Absolute abundance", title = "Hugerth dataset (2020)")+
  ylim(0,200000)
```

**Sequencing depth** characteristics of the Hugerth dataset:  
- minimum of `r min(sample_sums(physeq.hugerth))` total count per sample  
- median: `r median(sample_sums(physeq.hugerth))` total count per sample  
- maximum of `r max(sample_sums(physeq.hugerth))` total count per sample  



### 2. Relative abundances

```{r plot-relative-abundances, fig.width=10, fig.height = 5, message=FALSE}
# Agglomerate to phylum & class levels
phylum.table <- physeq.hugerth %>%
  tax_glom(taxrank = "Phylum") %>%                     # agglomerate at phylum level
  transform_sample_counts(function(x) {x/sum(x)} ) %>% # Transform to rel. abundance
  psmelt()                                             # Melt to long format

class.table <- physeq.hugerth %>%
  tax_glom(taxrank = "Class") %>%
  transform_sample_counts(function(x) {x/sum(x)} ) %>%
  psmelt()


# Plot relative abundances
ggplot(phylum.table, aes(x = reorder(Sample, Sample, function(x) mean(phylum.table[Sample == x & Phylum == 'Bacteroidota', 'Abundance'])),
                         y = Abundance, fill = Phylum))+
  facet_wrap(~ sample_type + host_disease, scales = "free") + # scales = "free" removes empty lines
  geom_bar(stat = "identity") +
  theme(axis.text.x = element_blank())+
  labs(x = "Samples", y = "Relative abundance", title = "Hugerth dataset (2020)")

ggplot(class.table, aes(x = reorder(Sample, Sample, function(x) mean(class.table[Sample == x & Class == 'Clostridia', 'Abundance'])),
                        y = Abundance, fill = Class))+
  facet_wrap(~ sample_type + host_disease, scales = "free") +
  geom_bar(stat = "identity") +
  theme(axis.text.x = element_text(size = 8, angle = -90))+
  labs(x = "Samples", y = "Relative abundance", title = "Hugerth dataset (2020)")
```



### 3. Firmicutes/Bacteroidota ratio

```{r plot-log-ratio, fig.height = 5, fig.width=3}
# Extract abundance of only Bacteroidota and Firmicutes
relevant.covariates <- c('Sample', 'Abundance', 'host_disease', 'Phylum', 'sample_type', 'host_ID', 'host_age', 'host_sex', 'host_bmi')

bacter <- phylum.table %>%
  filter(Phylum == "Bacteroidota") %>%
  select(all_of(relevant.covariates)) %>%
  rename(Bacteroidota = Abundance) %>%
  select(-Phylum)

firmi <- phylum.table %>%
  filter(Phylum == "Firmicutes") %>%
  select(all_of(relevant.covariates)) %>%
  rename(Firmicutes = Abundance) %>%
  select(-Phylum)

# Calculate log2 ratio Firmicutes/Bacteroidota
ratio.FB <- left_join(x=bacter, y=firmi, by=c('Sample', 'host_disease', 'sample_type', 'host_ID', 'host_age', 'host_sex', 'host_bmi')) %>%
  relocate(Firmicutes, .after=Bacteroidota) %>%
  # Compute log ratios
  mutate(logRatioFB = log2(Firmicutes/Bacteroidota))


# Plot log2 ratio Firmicutes/Bacteroidota
ggplot(ratio.FB, aes(x = host_disease, y = logRatioFB))+
  geom_violin(aes(fill=host_disease))+
  scale_fill_manual(values=alpha(c("blue", "red"), .3))+
  geom_jitter(width=0.1)+
  facet_wrap(~sample_type) +
  labs(x = "",  y = 'Log2(Firmicutes/Bacteroidota)', title = "Firmicutes:Bacteroidota ratio")+
  theme_cowplot()+
  theme(legend.position="none")

# Statistical test sigmoid samples
wilcox.test(ratio.FB[ratio.FB$sample_type == "sigmoid" & ratio.FB$host_disease == "IBS","logRatioFB"],
            ratio.FB[ratio.FB$sample_type == "sigmoid" & ratio.FB$host_disease == "Healthy","logRatioFB"]) # p = 0.6
# Statistical test stool samples
wilcox.test(ratio.FB[ratio.FB$sample_type == "stool" & ratio.FB$host_disease == "IBS","logRatioFB"],
            ratio.FB[ratio.FB$sample_type == "stool" & ratio.FB$host_disease == "Healthy","logRatioFB"]) # p=0.12


# Paired data
ggplot(ratio.FB, aes(x = sample_type, y = logRatioFB))+
  geom_violin(aes(fill=host_disease))+
  scale_fill_manual(values=alpha(c("blue", "red"), .3))+
  geom_point()+
  geom_line(aes(group=host_ID), lwd=0.1) +
  facet_wrap(~host_disease) +
  labs(x = "",  y = 'Log2(Firmicutes/Bacteroidota)', title = "Paired data") +
  theme_cowplot()+
  theme(legend.position="none")

# Statistical test sigmoid vs stool samples
wilcox.test(ratio.FB[ratio.FB$sample_type == "stool" & ratio.FB$host_disease == "Healthy","logRatioFB"],
            ratio.FB[ratio.FB$sample_type == "sigmoid" & ratio.FB$host_disease == "Healthy","logRatioFB"]) # p=0.1
wilcox.test(ratio.FB[ratio.FB$sample_type == "stool" & ratio.FB$host_disease == "IBS","logRatioFB"],
            ratio.FB[ratio.FB$sample_type == "sigmoid" & ratio.FB$host_disease == "IBS","logRatioFB"]) # p=0.3
```


```{r export-plots-1, eval = FALSE, echo = FALSE}
# Save path to plots
path.plots <- file.path(path, "data/analysis-individual/PLOTS/plots-Hugerth-EDA")

# Absolute abundance phylum
jpeg(file.path(path.plots, "absAbundance_phylum.jpg"), width = 4000, height = 2000)
plot_bar(physeq.hugerth, fill = "Phylum") + facet_wrap("host_disease", scales="free_x") +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_text(size = 30),
        legend.text = element_text(size = 50),
        axis.title = element_text(size = 50),
        title = element_text(size = 70),
        strip.text = element_text(size = 50))+
  labs(x = "Samples", y = "Total read count", title = "Hugerth dataset (2019)")+
  ylim(0, 200000)
dev.off()

# Relative abundances
jpeg(file.path(path.plots, "relAbundance_phylum.jpg"), width = 4000, height = 2000)
ggplot(phylum.table, aes(x = reorder(Sample, Sample, function(x) mean(phylum.table[Sample == x & Phylum == 'Bacteroidota', 'Abundance'])),
                         y = Abundance, fill = Phylum))+
  facet_wrap(~ sample_type + host_disease, scales = "free") + # scales = "free" removes empty lines
  geom_bar(stat = "identity") +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_text(size = 30),
        legend.text = element_text(size = 50),
        axis.title = element_text(size = 50),
        title = element_text(size = 70),
        strip.text = element_text(size = 50))+
  labs(x = "Samples", y = "Relative abundance", title = "Hugerth dataset (2020)")
dev.off()

jpeg(file.path(path.plots, "relAbundance_class.jpg"), width = 4000, height = 2000)
ggplot(class.table, aes(x = reorder(Sample, Sample, function(x) mean(phylum.table[Sample == x & Phylum == 'Bacteroidota', 'Abundance'])),
                        y = Abundance, fill = Class))+
  facet_wrap(~ sample_type + host_disease, scales = "free") +
  geom_bar(stat = "identity") +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_text(size = 30),
        legend.text = element_text(size = 50),
        axis.title = element_text(size = 50),
        title = element_text(size = 70),
        strip.text = element_text(size = 50))+
  labs(x = "Samples", y = "Relative abundance", title = "Hugerth dataset (2020)")
dev.off()


# Firmicutes:Bacteroidota log ratio (healthy/IBS)
jpeg(file.path(path.plots, "ratioFB.jpg"), width = 1500, height = 1500)
ggplot(ratio.FB, aes(x = host_disease, y = logRatioFB))+
  geom_violin(lwd=3, aes(fill=host_disease))+
  geom_jitter(size = 10, width=0.1)+
  scale_fill_manual(values=alpha(c("blue", "red"), .3))+
  facet_wrap(~sample_type) +
  labs(x = "",  y = 'Log2(Firmicutes/Bacteroidota)', title = "Firmicutes:Bacteroidota ratio")+
  theme_cowplot()+
  theme(axis.text = element_text(size = 50),
        strip.text = element_text(size=50),
        legend.position = "none",
        axis.title = element_text(size = 50),
        title = element_text(size = 50))
dev.off()

# Firmicutes:Bacteroidota log ratio (paired data stool/sigmoid)
jpeg(file.path(path.plots, "ratioFB_paired-data.jpg"), width = 1500, height = 1500)
ggplot(ratio.FB, aes(x = sample_type, y = logRatioFB))+
  geom_violin(lwd=3, aes(fill=host_disease))+
  geom_point(size = 10)+
  geom_line(aes(group=host_ID), lwd=0.5) +
  scale_fill_manual(values=alpha(c("blue", "red"), .3))+
  facet_wrap(~host_disease) +
  labs(x = "",  y = 'Log2(Firmicutes/Bacteroidota)', title = "Paired data") +
  theme_cowplot()+
  theme(axis.text = element_text(size = 50),
        strip.text = element_text(size=50),
        legend.position = "none",
        axis.title = element_text(size = 50),
        title = element_text(size = 50))
dev.off()
```




####################
## NORMALIZE DATA ##
####################

```{r normalize-data, eval = FALSE, echo = TRUE}
# Sanity check no sample with less than 500 total count
table(sample_sums(physeq.hugerth)<500) # all FALSE

#____________________________________________________________________
# PHYLOSEQ OBJECT WITH NON-ZERO COMPOSITIONS
physeq.NZcomp <- physeq.hugerth
otu_table(physeq.NZcomp)[otu_table(physeq.NZcomp) == 0] <- 0.5 # pseudocounts

# Sanity check that 0 values have been replaced
# otu_table(physeq.hugerth)[1:5,1:5]
# otu_table(physeq.NZcomp)[1:5,1:5]

# transform into compositions
physeq.NZcomp <- transform_sample_counts(physeq.NZcomp, function(x) x / sum(x) )
table(rowSums(otu_table(physeq.NZcomp))) # check if there is any row not summing to 1

# Save object
saveRDS(physeq.NZcomp, file.path(path, "data/analysis-individual/Hugerth-2019/02_EDA-Hugerth/physeq_NZcomp.rds"))

#____________________________________________________________________
# PHYLOSEQ OBJECT WITH RELATIVE COUNT (BETWEEN 0 AND 1)
physeq.rel <- physeq.hugerth
physeq.rel <- transform_sample_counts(physeq.rel, function(x) x / sum(x) )

# check the counts are all relative
# otu_table(physeq.hugerth)[1:5, 1:5]
# otu_table(physeq.rel)[1:5, 1:5]

# sanity check
table(rowSums(otu_table(physeq.rel))) # check if there is any row not summing to 1

# save the physeq.rel object
saveRDS(physeq.rel, file.path(path, "data/analysis-individual/Hugerth-2019/02_EDA-Hugerth/physeq_relative.rds"))

#____________________________________________________________________
# PHYLOSEQ OBJECT WITH COMMON-SCALE NORMALIZATION
physeq.CSN <- physeq.hugerth
physeq.CSN <- transform_sample_counts(physeq.CSN, function(x) (x*min(sample_sums(physeq.CSN))) / sum(x) )

# sanity check
table(rowSums(otu_table(physeq.CSN))) # check that all rows are summing to the same total

# save the physeq.CSN object
saveRDS(physeq.CSN, file.path(path, "data/analysis-individual/Hugerth-2019/02_EDA-Hugerth/physeq_CSN.rds"))


#____________________________________________________________________
# PHYLOSEQ OBJECT WITH CENTERED LOG RATIO COUNT
physeq.clr <- physeq.hugerth
physeq.clr <- microbiome::transform(physeq.hugerth, "clr") # the function adds pseudocounts itself

# Compare the otu tables in the original phyloseq object and the new one after CLR transformation
otu_table(physeq.hugerth)[1:5, 1:5] # should contain absolute counts
otu_table(physeq.clr)[1:5, 1:5] # should all be relative

# save the physeq.rel object
saveRDS(physeq.clr, file.path(path, "data/analysis-individual/Hugerth-2019/02_EDA-Hugerth/physeq_clr.rds"))
```




#######################
## COMPUTE DISTANCES ##
#######################

### 1. UniFrac, Aitchison, Bray-Curtis and Canberra

First, let's look at these four distances of interest.

```{r dist-functions, fig.width = 15, fig.height = 4}
#____________________________________________________________________________________
# Measure distances
Distances <- function(){
  set.seed(123) # for unifrac, need to set a seed
  print("Unifrac...")
  glom.UniF <-  UniFrac(subset_samples(physeq.rel), weighted=TRUE, normalized=TRUE) # weighted unifrac
  print("Aitchison...")
  glom.ait <- phyloseq::distance(subset_samples(physeq.clr), method = 'euclidean') # aitchison
  print("Bray-Curtis...")
  glom.bray <- phyloseq::distance(subset_samples(physeq.CSN), method = "bray") # bray-curtis
  print("Canberra...")
  glom.can <- phyloseq::distance(subset_samples(physeq.NZcomp), method = "canberra") # canberra
  dist.list <- list("UniF" = glom.UniF, "Ait" = glom.ait, "Canb" = glom.can, "Bray" = glom.bray)
  
  return(dist.list)
}
#subset_samples(physeq.clr, sample_names(physeq.clr) != 'SRR5245605')

# Get the fecal sample distances
dist.fecal <- Distances()
plot.fecal <- DistancesPlot(dist.fecal)
plot.fecal$author <- "Hugherth"

p1 <- ggplot(plot.fecal[plot.fecal$distance == "Weighted Unifrac",], aes(Axis.1, Axis.2, color=sample_type))+
  geom_point(size=12, alpha=0.7)  + scale_color_manual(values = c('#CC00FF', '#66CC00'))+
  facet_grid(author~distance, scales='free')+
  theme_bw()+
  theme(axis.title = element_blank(),
        #axis.title.x = element_text(size = 40),
        axis.text = element_text(size = 30),
        legend.text = element_text(size = 40),
        legend.title = element_text(size = 40),
        strip.background = element_rect(fill = "white", size = 3),
        panel.border = element_rect(size = 2),
        #strip.text.x = element_text(size = 50, margin = margin(1,0,1,0, "cm")),
        strip.text.x = element_blank(),
        strip.text.y = element_text(size = 70, margin = margin(0,1,0,1, "cm")),
        #axis.line = element_line(size = 1, arrow = arrow(length = unit(0.1, "inches")))
        )+
  labs(color="Disease")

p2 <- ggplot(plot.fecal[plot.fecal$distance != "Weighted Unifrac",], aes(Axis.1, Axis.2, color=sample_type))+
  geom_point(size=12, alpha=0.7)  + scale_color_manual(values = c('#CC00FF', '#66CC00'))+
  facet_wrap(~distance, scales='free', nrow = 1)+
  guides(color = FALSE)+
  theme_bw()+
  theme(axis.text = element_text(size = 30),
        axis.title.y = element_text(size = 40),
        axis.title.x = element_blank(),
        strip.background = element_rect(fill = "white", size = 1),
        panel.border = element_rect(size = 2),
        #strip.text = element_text(size = 50, margin = margin(1,0,1,0, "cm")),
        strip.text.x = element_blank(),
        #axis.line = element_line(size = 1, arrow = arrow(length = unit(0.1, "inches")))
        )

jpeg("/Users/scarcy/Desktop/Praktikum/Data/Hugherth_2020/RProject_DataAnalysis/Plots/dist_sampletype.jpg", height = 800, width = 4000, res = 100)
ggarrange(p2, p1, ncol = 2, widths = c(2,1))
dev.off()


#####
DistancesPlot <- function(d){
  plist <- NULL
  plist <- vector("list", 4)
  names(plist) <- c("Weighted Unifrac", "Aitchison", "Bray-Curtis", "Canberra")
  
  print("Unifrac")
  # Weighted UniFrac
  set.seed(123)
  iMDS.UniF <- ordinate(physeq.rel, "MDS", distance=d$UniF)
  plist[[1]] <- plot_ordination(physeq.rel, iMDS.UniF, color="host_disease")
  
  print("Aitchison")
  # Aitchison
  set.seed(123)
  iMDS.Ait <- ordinate(physeq.clr, "MDS", distance=d$Ait)
  plist[[2]] <- plot_ordination(physeq.clr, iMDS.Ait, color="host_disease")
  
  print("Bray")
  # Bray-Curtis
  set.seed(123)
  iMDS.Bray <- ordinate(physeq.CSN, "MDS", distance=d$Bray)
  plist[[3]] <- plot_ordination(physeq.CSN, iMDS.Bray, color="host_disease")
  
  print("Canberra")
  # Canberra
  set.seed(123)
  iMDS.Can <- ordinate(physeq.NZcomp, "MDS", distance=d$Can)
  plist[[4]] <- plot_ordination(physeq.NZcomp, iMDS.Can, color="host_disease")
  
  # Creating a dataframe to plot everything
  plot.df = ldply(plist, function(x) x$data)
  names(plot.df)[1] <- "distance"
  
  return(plot.df)
}

dist.thesis <- Distances()
plot.df <- DistancesPlot(dist.thesis)
plot.df$author <- "Hugherth"

p1 <- ggplot(plot.df[plot.df$distance == "Weighted Unifrac",], aes(Axis.1, Axis.2, color=host_disease))+
  geom_point(size=12, alpha=0.4)  + scale_color_manual(values = c('blue', 'red'))+
  facet_grid(author~distance, scales='free')+
  theme_bw()+
  theme(axis.title = element_blank(),
        #axis.title.x = element_text(size = 40),
        axis.text = element_text(size = 30),
        legend.text = element_text(size = 40),
        legend.title = element_text(size = 40),
        strip.background = element_rect(fill = "white", size = 3),
        panel.border = element_rect(size = 2),
        #strip.text.x = element_text(size = 50, margin = margin(1,0,1,0, "cm")),
        strip.text.x = element_blank(),
        strip.text.y = element_text(size = 70, margin = margin(0,1,0,1, "cm")),
        #axis.line = element_line(size = 1, arrow = arrow(length = unit(0.1, "inches")))
        )+
  labs(color="Disease")

p2 <- ggplot(plot.df[plot.df$distance != "Weighted Unifrac",], aes(Axis.1, Axis.2, color=host_disease))+
  geom_point(size=12, alpha=0.4)  + scale_color_manual(values = c('blue', 'red'))+
  facet_wrap(~distance, scales='free', nrow = 1)+
  guides(color = FALSE)+
  theme_bw()+
  theme(axis.text = element_text(size = 30),
        axis.title.y = element_text(size = 40),
        axis.title.x = element_blank(),
        strip.background = element_rect(fill = "white", size = 1),
        panel.border = element_rect(size = 2),
        #strip.text = element_text(size = 50, margin = margin(1,0,1,0, "cm")),
        strip.text.x = element_blank(),
        #axis.line = element_line(size = 1, arrow = arrow(length = unit(0.1, "inches")))
        )

jpeg("/Users/scarcy/Desktop/Praktikum/Thesis/dist_Hugherth_02.jpeg", height = 800, width = 4000, res = 100)
ggarrange(p2, p1, ncol = 2, widths = c(2,1))
dev.off()
```

```{r}
# Function that will allow to color the leaves of the tree according to sample type (biopsy vs stool)
color_leaf<<-function(n){
    if(is.leaf(n)){
        # take the current attributes
        a=attributes(n)
        
        # deduce the line in the original data, to get the corresponding sampleType status
        line=match(attributes(n)$label, metadata_table$Run)
        disease=metadata_table[line, "host_disease"];
            if(disease=="Healthy"){col_disease="blue"};if(disease=="IBS"){col_disease="red"}
        
        #Modification of leaf attribute
        attr(n,"nodePar") <- c(a$nodePar, list(cex=1.5, lab.cex=0.6, pch=20, col=col_disease, lab.font=1, lab.cex=1))
        }
    return(n)
}

```

```{r, fig.height = 5, fig.width = 3}
hc.ward <- hclust(no_glom.dist$Canb, method = "ward.D") #clustering 
dend.ward <- as.dendrogram(hc.ward) # Make into dendograms

dend.ward <- dendrapply(dend.ward, color_leaf) # Apply the color attributes to the dendograms

jpeg("/Users/scarcy/Desktop/Praktikum/Thesis/hclust_Hugherth.jpg", height = 2000, width = 1000, res = 200)
plot(dend.ward , main="Hierarchical clustering on Canberra distance (ward linkage)", horiz = TRUE, leaflab = "none",
     edgePar = list(lwd = 2))
axis(side = 1, lwd = 4)
legend(4, 50, 
     legend = c("Healthy" , "IBS"), 
     col = c("blue", "red"), 
     pch = c(20,20), bty = "n",  pt.cex = 1.5, cex = 1, 
     text.col = "black", horiz = FALSE, inset = c(0, 0.1))
dev.off()
```


```{r dist-functions, eval = TRUE, echo = TRUE}
#____________________________________________________________________________________
# Measure distances
Distances <- function(physeq_obj){
  set.seed(123) # for unifrac, need to set a seed
  glom.UniF <-  UniFrac(physeq_obj, weighted=TRUE, normalized=TRUE) # weighted unifrac
  glom.ait <- distance(subset_samples(physeq.clr, sample_names(physeq.clr) != 'SRR5245605'), method = 'euclidean') # aitchison
  glom.bray <- distance(physeq_obj, method = "bray") # bray-curtis
  glom.jac <- distance(physeq_obj, method = "jaccard") # jaccard
  glom.can <- distance(physeq_obj, method = "canberra") # canberra
  dist.list <- list("UniF" = glom.UniF, "Ait" = glom.ait, "Canb" = glom.can, "Bray" = glom.bray, "Jac" = glom.jac)
  
  return(dist.list)
}

#____________________________________________________________________________________
# Plot 2D ordination
MDS_2D <- function(physeq_obj, ait_dist){
  
  plist <- NULL
  plist <- vector("list", length(dist_methods)+1) # save each plot to a list
  names(plist) <- dist_methods # save the name of each method
  names(plist)[17] <- "aitchison" # save the name of aitchison
  
  # Loop through all distance methods
  for(i in dist_methods){
    # Calculate distance matrix
    print(i)
    set.seed(123) # in case the distance method needs a rooted tree (weighted unifrac)
    iDist <- phyloseq::distance(physeq_obj, method=i)
    # Calculate ordination
    set.seed(123)
    iMDS  <- ordinate(physeq_obj, "MDS", distance=iDist)
    ## Make plot
    # Don't carry over previous plot (if error, p will be blank)
    p <- NULL
    # Create plot, store as temporary variable, p
    p <- plot_ordination(physeq_obj, iMDS, color="host_disease")
    # Add title to each plot
    p <- p + ggtitle(paste("MDS using distance method ", i, sep=""))
    # Save the graphic to the plot list
    plist[[i]] = p
  }
  
  # Add aitchison
  iMDS  <- ordinate(physeq_obj, "MDS", distance=ait_dist)
  p <- NULL
  p <- plot_ordination(physeq_obj, iMDS, color="host_disease")
  p <- p + ggtitle("MDS using distance method Aitchison")
  plist[[17]] = p
  
  # Creating a dataframe to plot everything
  plot.df = ldply(plist, function(x) x$data)
  names(plot.df)[1] <- "distance"
  
  # Plot
  p.alldist <- ggplot(plot.df, aes(Axis.1, Axis.2, color=host_disease))+
    geom_point(size=5, alpha=0.5)  + scale_color_manual(values = c('blue', 'red'))+
    facet_wrap(~distance, scales='free')+
    theme(strip.text = element_text(size = 40),
          legend.text = element_text(size = 20),
          axis.text.x = element_text(size = 20),
          axis.text.y = element_text(size = 20))

  return(p.alldist)
}

#____________________________________________________________________________________
# Plot 3D ordination
MDS_3D <- function(d, name_dist){
  
  # Reset parameters
  mds.3D <- NULL
  xyz <- NULL
  fig.3D <- NULL
  
  # Reduce distance matrix to 3 dimensions
  set.seed(123) # to get the same dimensionality reduction at each run
  mds.3D <- metaMDS(d, method="MDS", k=3, trace = 0)
  xyz <- scores(mds.3D, display="sites") # pull out the x y z coordinates
  
  if(name_dist == 'Aitchison'){
    fig.3D <- plot_ly(x=xyz[,1], y=xyz[,2], z=xyz[,3], type='scatter3d', mode='markers',
                      color=sample_data(physeq.clr)$host_disease,
                      colors = c('blue', 'red')) %>%
    layout(title = paste('MDS in 3D with', name_dist, 'distance', sep = ' '))
  }
  
  else{
    fig.3D <- plot_ly(x=xyz[,1], y=xyz[,2], z=xyz[,3], type='scatter3d',
                       mode='markers', color=sample_data(physeq.rel)$host_disease, colors = c('blue', 'red')) %>%
      layout(title = paste('MDS in 3D with', name_dist, 'distance', sep = ' '))
  }
  
  return(fig.3D)
}

```


```{r no-glom1, fig.height = 20, fig.width = 30}
# Get the distances
no_glom.dist <- Distances()

# Get the 2D ordination plots
no_glom.2D.alldist <- MDS_2D(physeq.NZcomp, dist.thesis$Ait)
no_glom.2D.alldist + theme(title = element_text(size = 30))

```


```{r save-distances, eval = FALSE, echo = FALSE}
getwd()

write.csv(as.matrix(no_glom.dist$UniF), file = "dist_wunifrac.csv", row.names = TRUE)
write.csv(as.matrix(no_glom.dist$Bray), file = "dist_brayCurtis.csv", row.names = TRUE)
write.csv(as.matrix(no_glom.dist$Ait), file = "dist_aitchison.csv", row.names = TRUE)
write.csv(as.matrix(no_glom.dist$Canb), file = "dist_canberra.csv", row.names = TRUE)
```



```{r no-glom2, fig.height = 6, fig.width = 10, message = FALSE, warning = FALSE}
# Get 3D MDS plots
no_glom.3D.UniF <- MDS_3D(dist.thesis$UniF, 'weighted Unifrac')
no_glom.3D.Ait <- MDS_3D(dist.thesis$Ait, 'Aitchison')
no_glom.3D.Jac <- MDS_3D(dist.thesis$Bray, 'Bray-Curtis')
no_glom.3D.Can <- MDS_3D(dist.thesis$Canb, 'Canberra')

no_glom.3D.UniF
no_glom.3D.Ait
no_glom.3D.Jac
no_glom.3D.Can
```



#############################
## HIERARCHICAL CLUSTERING ##
#############################

```{r hierarchical-clust, fig.width = 10, fig.width = 7}
Heatmaps <- function(dist_list, fontsize){
  # Weighted Unifrac
  heatmp.UniF <- pheatmap(as.matrix(dist_list$UniF), 
                          clustering_distance_rows = dist_list$UniF,
                          clustering_distance_cols = dist_list$UniF,
                          fontsize = fontsize,
                          fontsize_col = fontsize-5,
                          fontsize_row = fontsize-5,
                          annotation_col = mat_col,
                          annotation_row = mat_col,
                          annotation_colors = list(group = c('Healthy' = 'blue', 'IBS' = 'red'),
                                                   sample_type = c('sigmoid' = '#CC00FF', 'stool' = '#66CC00')),
                          cluster_rows = T,
                          cluster_cols = T,
                          clustering_method = 'complete', #hierarchical method
                          main = 'Weighted unifrac distance')

  # Aitchison
  heatmp.Ait <- pheatmap(as.matrix(dist_list$Ait), 
                         clustering_distance_rows = dist_list$Ait,
                         clustering_distance_cols = dist_list$Ait,
                         fontsize = fontsize,
                         fontsize_col = fontsize-5,
                         fontsize_row = fontsize-5,
                         # border_color = NA,
                         cluster_rows = T,
                         cluster_cols = T,
                         clustering_method = "complete", #hierarchical method
                         annotation_col = mat_col,
                         annotation_row = mat_col,
                         annotation_colors = list(group = c('Healthy' = 'blue', 'IBS' = 'red'),
                                                  sample_type = c('sigmoid' = '#CC00FF', 'stool' = '#66CC00')),
                         main = "Aitchison distance")
  
  # Bray-Curtis
  heatmp.Bray <- pheatmap(as.matrix(dist_list$Bray), 
                         clustering_distance_rows = dist_list$Bray,
                         clustering_distance_cols = dist_list$Bray,
                         fontsize = fontsize,
                         fontsize_col = fontsize-5,
                         fontsize_row = fontsize-5,
                         # border_color = NA,
                         cluster_rows = T,
                         cluster_cols = T,
                         clustering_method = "complete", #hierarchical method
                         annotation_col = mat_col,
                         annotation_row = mat_col,
                         annotation_colors = list(group = c('Healthy' = 'blue', 'IBS' = 'red'),
                                                  sample_type = c('sigmoid' = '#CC00FF', 'stool' = '#66CC00')),
                         main = "Bray-Curtis distance")
  
  # Canberra
  heatmp.Canb <- pheatmap(as.matrix(dist_list$Canb), 
                         clustering_distance_rows = dist_list$Canb,
                         clustering_distance_cols = dist_list$Canb,
                         fontsize = fontsize,
                         fontsize_col = fontsize-5,
                         fontsize_row = fontsize-5,
                         # border_color = NA,
                         cluster_rows = T,
                         cluster_cols = T,
                         clustering_method = "complete", #hierarchical method
                         annotation_col = mat_col,
                         annotation_row = mat_col,
                         annotation_colors = list(group = c('Healthy' = 'blue', 'IBS' = 'red'),
                                                  sample_type = c('sigmoid' = '#CC00FF', 'stool' = '#66CC00')),
                         main = "Canberra distance")
  
  return(list("UniF" = heatmp.UniF, "Ait" = heatmp.Ait, "Bray" = heatmp.Bray, "Canb" = heatmp.Canb))
}


# Get the heatmaps
no_glom.heatmaps <- Heatmaps(dist_list = no_glom.dist, fontsize = 8)
```



```{r export-plots-2, eval = FALSE, echo = FALSE}
# MDS 2D all distances
jpeg("./Plots/AllDistances_MDS.jpg", width = 3000, height = 2000, res = 90)
no_glom.2D.alldist +
  theme(axis.text.x = element_text(size = 20),
        legend.text = element_text(size = 50),
        axis.title = element_text(size = 50),
        title = element_text(size = 70),
        strip.text = element_text(size = 50))+
  labs(title = "Hugherth dataset (2020)")
dev.off()

# Heatmaps
jpeg("./Plots/Heatmap_Aitchison.jpg", width = 1400, height = 1000, res = 200)
no_glom.heatmaps$Ait
dev.off()

jpeg("./Plots/Heatmap_UniF.jpg", width = 1400, height = 1000, res = 200)
no_glom.heatmaps$UniF
dev.off()

jpeg("./Plots/Heatmap_BrayCurtis.jpg", width = 1400, height = 1000, res = 200)
no_glom.heatmaps$Bray
dev.off()

jpeg("./Plots/Heatmap_Canberra.jpg", width = 1400, height = 1000, res = 200)
no_glom.heatmaps$Can
dev.off()

```


################################
## REPRODUCE PLOTS FROM PAPER ##
################################

```{r reproduce-plots, eval = TRUE, echo = TRUE, fig.height = 6, fig.width = 10}
#___________________________________________________________________
# FIGURE 1A
set.seed(785)
UniF.test = UniFrac(physeq, weighted=FALSE, normalized=T) # unweighted Unifrac dist

UniF.PCoA <- ordinate(physeq, "PCoA", distance = UniF.test) # PCoA on unweighted unifrac dist
plot_ordination(physeq, UniF.PCoA, color="host_disease")

# Plotting the first 3 dimensions of the PCoA
xyz <- as.matrix(UniF.PCoA$vectors[,1:3])
test.plot <- plot_ly(x=xyz[,1], y=xyz[,2], z=xyz[,3], type="scatter3d",
                       mode="markers", color=sample_data(physeq)$host_disease, colors = c("blue", "red"))%>%
  layout(title = "PCoA in 3D with unweighted Unifrac distance")
test.plot


#___________________________________________________________________
# FIGURE 1B

# Hierarchical clustering using average linkage
hc.average <- hclust(UniF.test, method = "average")
dend.average <- as.dendrogram(hc.average)
color_leaf<<-function(n){
    if(is.leaf(n)){
        # take the current attributes
        a=attributes(n)
        
        # deduce the line in the original data, to get the corresponding disease status
        line=match(attributes(n)$label, rownames(metadata_table))
        disease=metadata_table[line, "host_disease"];
            if(disease=="Healthy"){col_disease="blue"};if(disease=="IBS"){col_disease="red"}
        
        #Modification of leaf attribute
        attr(n,"nodePar") <- c(a$nodePar, list(cex=1.5, lab.cex=0.6, pch=20, col=col_disease, lab.font=1, lab.cex=0.1))
        }
    return(n)
}
dend.average <- dendrapply(dend.average, color_leaf)

#Plot
par(mar=c(3,2,3,7), xpd=T, cex = 0.8)
plot(dend.average , main="Hierarchical clustering: average linkage", horiz = T, cex = 0.1)
legend('topleft',
     legend = c("Healthy" , "IBS"), 
     col = c("blue", "red"), 
     pch = c(20,20), bty = "n",  pt.cex = 1.5, cex = 1, 
     text.col = "black", horiz = FALSE, inset = c(0, 0.1))
```


