---
title: "UMAP"
output: html_notebook
---


##########
# IMPORT #
##########

## Import libraries

```{r import-libraries, echo = FALSE}
library(phyloseq)
library(ggplot2)
library(plotly)
library(pals)
library(umap)
library(tidyverse)
library(reshape2)
library(gtools)
```


## Import data

```{r import-data}
path.phy <- "~/Projects/IBS_Meta-analysis_16S/data/analysis-individual/CLUSTER/PhyloTree/input"

# Import phyloseq objects
physeq.ringel <- readRDS(file.path(path.phy, "physeq_ringel.rds"))
physeq.labus <- readRDS(file.path(path.phy, "physeq_labus.rds"))
physeq.lopresti <- readRDS(file.path(path.phy, "physeq_lopresti.rds"))
physeq.pozuelo <- readRDS(file.path(path.phy, "physeq_pozuelo.rds"))
physeq.zhuang <- readRDS(file.path(path.phy, "physeq_zhuang.rds"))
physeq.zhu <- readRDS(file.path(path.phy, "physeq_zhu.rds"))
physeq.hugerth <- readRDS(file.path(path.phy, "physeq_hugerth.rds"))
physeq.fukui <- readRDS(file.path(path.phy, "physeq_fukui.rds"))
physeq.mars <- readRDS(file.path(path.phy, "physeq_mars.rds"))
physeq.liu <- readRDS(file.path(path.phy, "physeq_liu.rds"))
physeq.agp <- readRDS(file.path(path.phy, "physeq_agp.rds"))
physeq.nagel <- readRDS(file.path(path.phy, "physeq_nagel.rds"))
physeq.zeber <- readRDS(file.path(path.phy, "physeq_zeber.rds"))

# Little changes
# sample_data(physeq.labus)[sample_data(physeq.labus)$host_disease == "None","host_disease"] <- "Healthy"
# sample_data(physeq.labus)$sample_type <- "stool"
# sample_data(physeq.zhu)$sample_type <- "stool"

# Sanity checks
# table(tax_table(physeq.zeber)[,1])
# table(is.na(tax_table(physeq.zeber)[,2]))
# table(sample_sums(physeq.zeber)<500)
```



##################
# MERGE DATASETS #
##################

## Merge datasets

```{r merge-datasets}
# Merge phyloseq objects
physeq <- merge_phyloseq(physeq.ringel,
                         physeq.labus,
                         physeq.lopresti,
                         physeq.pozuelo,
                         physeq.zhuang,
                         physeq.zhu,
                         physeq.hugerth,
                         physeq.fukui,
                         physeq.mars,
                         physeq.liu,
                         physeq.agp,
                         physeq.nagel,
                         physeq.zeber)

# check on sample_data
colnames(sample_data(physeq))
table(sample_data(physeq)$author, useNA="ifany") #ok
table(sample_data(physeq)$sequencing_tech, useNA="ifany") #ok
table(sample_data(physeq)$variable_region, useNA="ifany") # ok

table(sample_data(physeq)$host_disease, useNA="ifany") # ok
table(sample_data(physeq)$host_subtype, useNA="ifany") # ok
table(sample_data(physeq)$sample_type, useNA="ifany") # ok

table(sample_data(physeq)$host_sex, useNA="ifany") # ok
table(sample_data(physeq)$host_age, useNA="ifany") # ok
table(sample_data(physeq)$host_bmi, useNA="ifany") # ok
table(sample_data(physeq)$Collection, useNA="ifany") # ok
```


## Normalize data

```{r normalize}
# Keep only fecal samples
physeq.fecal <- subset_samples(physeq, sample_type == 'stool') # 2,228 samples
physeq.sigmoid <- subset_samples(physeq, sample_type == 'sigmoid') # 431 samples

# Have pseudocounts
physeq_fecal.pseudocts <- physeq.fecal
otu_table(physeq_fecal.pseudocts)[otu_table(physeq_fecal.pseudocts) == 0] <- 0.5

physeq_sigmoid.pseudocts <- physeq.sigmoid
otu_table(physeq_sigmoid.pseudocts)[otu_table(physeq_sigmoid.pseudocts) == 0] <- 0.5
```


###########################
# UMAP ON TAXA LOG-RATIOS #
###########################

#______________________
## FUNCTIONS

This function takes an abundance matrix (taxa as rows, samples as columns) and computes all pairwise log ratios.

```{r functions}
#________________________
# LOG-RATIOS

LogRatios <- function(abundanceTable){
  
  # Get combinations between all taxa, 1st column numerator, 2nd column denominator, 3rd column taxa1/taxa2
  comb <- as.data.frame(combinations(nrow(abundanceTable), 2, rownames(abundanceTable), repeats.allowed = FALSE))
  comb[,3] <- paste0(comb[,1], "/", comb[,2])
  
  cat("Number of combinations:", nrow(comb), "\n")

  # Compute the ratios
  ratios <- as.data.frame(abundanceTable) # taxa as rows, samples as columns
  test <- ratios[1:3,1:3] # for later sanity check
  
  ratios[ comb[,3] ,] <- mapply(function(x, y) log2(x/y), # compute the log ratio
                                abundanceTable[ as.character(comb[,1]) ,], # between first column
                                abundanceTable[ as.character(comb[,2]) ,]) # and second column of all combinations

  ratios <- ratios[-c(1:nrow(abundanceTable)),] # remove first x rows that are not ratios (it is simply the taxa)
  
  # sanity check
  cat("Sanity check: log-ratio is", log2(test[1,1]/test[2,1]),
      "and the corresponding value in the log-ratio table is", ratios[1,1], "\n")
  cat("Sanity check2: log-ratio is", log2(test[1,2]/test[3,2]),
      "and the corresponding value in the log-ratio table is", ratios[2,2], "\n")
  
  cat("We have", dim(ratios)[2], "samples and", dim(ratios)[1], "predictors (log-ratios) \n")

  # Return table with samples as rows and logratios as columns
  return(t(ratios))
}
```


This table will be useful to save covariates for UMAP plotting.

```{r covariates}
covariates <- data.frame(disease = sample_data(physeq_fecal.pseudocts)[,'host_disease'],
                         subtype = sample_data(physeq_fecal.pseudocts)[,'host_subtype'],
                         seq_tech = sample_data(physeq_fecal.pseudocts)[,'sequencing_tech'],
                         author = sample_data(physeq_fecal.pseudocts)[,'author'],
                         variable_region = sample_data(physeq_fecal.pseudocts)[,'variable_region'],
                         age = sample_data(physeq_fecal.pseudocts)[,'host_age'],
                         bmi = sample_data(physeq_fecal.pseudocts)[,'host_bmi'],
                         collection=sample_data(physeq_fecal.pseudocts)[,'Collection'])
# table(covariates$host_subtype, useNA="ifany")
```


#______________________
## FECAL DATA

### FAMILY AGGREGATION

First, let's get a table with samples as rows and family log ratios as columns

```{r agglom-family}
# Get the familyTable
fam.agg <- physeq_fecal.pseudocts %>%
  tax_glom(taxrank = "Family") %>%
  psmelt()
familyTable <- acast(family.agg, Family ~ Sample, value.var = 'Abundance')
# saveRDS(fam.agg, "~/Projects/IBS_Meta-analysis_16S/data/analysis-combined/02_UMAP/family_agg.rds")

# sanity checks
# dim(familyTable) # 360 families
# table(familyTable == 0)

# Get log-ratios for family table
ratiosFam <- LogRatios(familyTable)
# saveRDS(ratiosFam, "~/Projects/IBS_Meta-analysis_16S/data/analysis-combined/02_UMAP/ratiosFam.rds")

# Mean centering
ratiosFam.scaled <- scale(ratiosFam, center = TRUE, scale = FALSE)
table(is.na(ratiosFam.scaled)) # sanity check
```

Now we can run UMAP.

```{r umap-family}
# Run UMAP
set.seed(123)
umapFam <- uwot::umap(ratiosFam.scaled, # umap on samples (rows) and families abundances (columns)
                      n_neighbors=20, n_components=3, n_threads=8)
#30min
# saveRDS(umapFam, "~/Projects/IBS_Meta-analysis_16S/data/analysis-combined/02_UMAP/umapFam.rds")

# Get the (x,y) coordinates from the UMAP
dims.umapFam <- umapFam %>% as.data.frame()
colnames(dims.umapFam) <- c("UMAP_1", "UMAP_2", "UMAP_3")
rownames(dims.umapFam) <- rownames(ratiosFam.scaled)

# Add covariates
dims.umapFam <- merge(as.data.frame(dims.umapFam), covariates, by="row.names") # umap+covariates
```

Plot UMAP.

```{r umap-plot-family}
# PLOT host_disease
ggplot(dims.umapFam, aes(x = UMAP_1, y = UMAP_2, color = host_disease))+
  geom_point(size = 2, alpha = 0.7)+
  scale_color_manual(values = c('blue', 'red', 'black'))+
  labs(title = 'Agglomeration at Family level')+
  theme_bw()
ggsave("~/Projects/IBS_Meta-analysis_16S/data/analysis-combined/02_UMAP/umapFam_disease.jpg", width=6, height=4)


# PLOT host_subtype
ggplot(dims.umapFam, aes(x = UMAP_1, y = UMAP_2, color = host_subtype))+
  geom_point(size = 1, alpha = 0.7)+
  scale_color_manual(values = c('#99CCFF', '#FF3300', '#990000', '#FF66CC','#FFFF66', '#CCCCCC'))+
  labs(title = 'Agglomeration at Family level')+
  theme_bw()
ggsave("~/Projects/IBS_Meta-analysis_16S/data/analysis-combined/02_UMAP/umapFam_subtype.jpg", width=6, height=4)


# PLOT author
ggplot(dims.umapFam, aes(x = UMAP_1, y = UMAP_2, color = author))+
  geom_point(size = 2, alpha = 0.7)+
  scale_color_manual(values=brewer.paired(n=12))+
  #scale_color_manual(values=c(rep("grey", 11), "red"))+
  theme_bw()
plotly::plot_ly() %>%
  add_trace(data=dims.umapFam,
            x=~UMAP_1, y=~UMAP_2, z=~UMAP_3,
            color=~author,
            colors=brewer.paired(n=12),
            #colors=c('#6600FF', '#33CC33', '#006600', '#FF6633'),
            type="scatter3d",
            mode="markers",
            marker=list(size=3))
#ggsave("~/Projects/IBS_Meta-analysis_16S/data/analysis-combined/02_UMAP/umapFam_author.jpg", width=6, height=4)


# PLOT seqtech
ggplot(dims.umapFam, aes(x = UMAP_1, y = UMAP_2, color = sequencing_tech))+
  geom_point(size = 2, alpha = 0.7)+
  scale_color_manual(values = c('#6600FF', '#33CC33', '#006600', '#FF6633'))+
  theme_bw()
plotly::plot_ly() %>%
  add_trace(data=dims.umapFam,
            x=~UMAP_1, y=~UMAP_2, z=~UMAP_3, color=~sequencing_tech, type="scatter3d", mode="markers")
# ggsave("~/Projects/IBS_Meta-analysis_16S/data/analysis-combined/02_UMAP/umapFam_seqtech.jpg", width=6, height=4)


# PLOT variable region
ggplot(dims.umapFam, aes(x = UMAP_1, y = UMAP_2, color = variable_region))+
  geom_point(size = 2, alpha = 0.7)+
  theme_bw()
ggsave("~/Projects/IBS_Meta-analysis_16S/data/analysis-combined/02_UMAP/umapFam_vregion.jpg", width=6, height=4)
```



#___________________
## SIGMOID DATA

```{r sigmoid}
# Get the familyTable
fam.agg.sigmoid <- physeq_sigmoid.pseudocts %>%
  tax_glom(taxrank = "Family") %>%
  psmelt()
familyTable.sigmoid <- acast(fam.agg.sigmoid, Family ~ Sample, value.var = 'Abundance')

# sanity checks
dim(familyTable.sigmoid)
table(familyTable.sigmoid == 0)

# Get log-ratios for family table
ratiosFam.sigmoid <- LogRatios(familyTable.sigmoid)

# Mean centering
ratiosFam.sigmoid.scaled <- scale(ratiosFam.sigmoid, center = TRUE, scale = FALSE)
table(is.na(ratiosFam.sigmoid.scaled)) # sanity check

# Run UMAP
umapFam.sigmoid <- umap(ratiosFam.sigmoid.scaled, n_neighbors=50) # umap on samples (rows) and families abundances (columns)
#30min
# Get the (x,y) coordinates from the UMAP
dims.umapFam.sigmoid <- umapFam.sigmoid$layout
colnames(dims.umapFam.sigmoid) <- c("UMAP_1", "UMAP_2")

# Add covariates
cov.sigmoid <- data.frame(disease = sample_data(physeq.sigmoid.pseudocts)[,'host_disease'],
                        seq_tech = sample_data(physeq.sigmoid.pseudocts)[,'sequencing_tech'],
                        author = sample_data(physeq.sigmoid.pseudocts)[,'author'],
                        variable_region = sample_data(physeq.sigmoid.pseudocts)[,'variable_region'],
                        age = sample_data(physeq.sigmoid.pseudocts)[,'host_age'],
                        bmi = sample_data(physeq.sigmoid.pseudocts)[,'host_bmi'],
                        subtype = sample_data(physeq.sigmoid.pseudocts)[,'host_subtype'])

dims.umapFam.sigmoid <- merge(as.data.frame(dims.umapFam.sigmoid), cov.sigmoid, by="row.names") # umap+covariates

# PLOT host_disease
ggplot(dims.umapFam.sigmoid, aes(x = UMAP_1, y = UMAP_2, color = host_disease))+
  geom_point(size = 2, alpha = 0.7)+
  scale_color_manual(values = c('blue', 'red', 'black'))+
  labs(title = 'Agglomeration at Family level')+
  theme_bw()

# PLOT host_subtype
ggplot(dims.umapFam.sigmoid, aes(x = UMAP_1, y = UMAP_2, color = host_subtype))+
  geom_point(size = 1, alpha = 0.7)+
  scale_color_manual(values = c('#99CCFF', '#FF3300', '#990000', '#FF66CC','#FFFF66', '#CCCCCC'))+
  labs(title = 'Agglomeration at Family level')+
  theme_bw()

# PLOT author
ggplot(dims.umapFam.sigmoid, aes(x = UMAP_1, y = UMAP_2, color = author))+
  geom_point(size = 2, alpha = 0.7)+
  theme_bw()

# PLOT seqtech
ggplot(dims.umapFam.sigmoid, aes(x = UMAP_1, y = UMAP_2, color = sequencing_tech))+
  geom_point(size = 2, alpha = 0.7)+
  scale_color_manual(values = c('#6600FF', '#33CC33', '#006600', '#FF6633'))+
  theme_bw()

# PLOT variable region
ggplot(dims.umapFam.sigmoid, aes(x = UMAP_1, y = UMAP_2, color = variable_region))+
  geom_point(size = 2, alpha = 0.7)+
  theme_bw()
```




###########################
# REPRODUCE MASTER THESIS #
###########################

```{r master-thesis}
# Get phyloseq object
physeq.small <- merge_phyloseq(physeq.ringel,
                               physeq.labus,
                               physeq.lopresti,
                               physeq.pozuelo,
                               physeq.zhuang,
                               physeq.zhu,
                               physeq.zeber)
# Keep only fecal samples
physeq.small <- subset_samples(physeq.small, sample_type == 'stool') # 612 samples

# Get the familyTable
physeq.small.pseudocts <- physeq.small
otu_table(physeq.small.pseudocts)[otu_table(physeq.small.pseudocts) == 0] <- 0.5
agg.small <- physeq.small.pseudocts %>%
  tax_glom(taxrank = "Family") %>%                     # agglomerate at genus level
  psmelt()                                             # Melt to long format
familyTable.small <- acast(agg.small, Family ~ Sample, value.var = 'Abundance')
# familyTable.small[familyTable.small == 0] <- 10e-7 # add pseudocounts for heatmap
dim(familyTable.small)

# Get log-ratios for family table
ratiosFam.small <- LogRatios(familyTable.small)

# Mean centering
ratiosFam.small <- scale(ratiosFam.small, center = TRUE, scale = TRUE)
table(is.na(ratiosFam.small))

# UMAP
umap.small <- umap(ratiosFam.small, n_neighbors=100) #umap on samples (rows) and families abundances (columns)
dims_umap.small <- umap.small$layout # extract coordinates
colnames(dims_umap.small) <- c("UMAP_1", "UMAP_2")

# Add covariates
mat_col <- data.frame(disease = sample_data(physeq.small)[,'host_disease'],
                        seq_tech = sample_data(physeq.small)[,'sequencing_tech'],
                        author = sample_data(physeq.small)[,'author'])
mat_col[is.na(mat_col$host_disease), "host_disease"] <- "NA"
mat_col[mat_col$author == "Pozuelo", "sequencing_tech"] <- "Illumina MiSeq single-end"
mat_col[mat_col$author %in% c("Zhuang", "Zhu"), "sequencing_tech"] <- "Illumina MiSeq paired-end"
dims_umap.small <- merge(as.data.frame(dims_umap.small), mat_col, by="row.names") # umap+covariates

# PLOT
ggplot(dims_umap.small, aes(x = UMAP_1, y = UMAP_2, color = host_disease))+
  geom_point(size = 1, alpha = 0.7)+
  scale_color_manual(values = c('blue', 'red', 'black'))+
  labs(title = 'Agglomeration at Family level')+
  theme_bw()

ggplot(dims_umap.small, aes(x = UMAP_1, y = UMAP_2, color = author))+
  geom_point(size = 2, alpha = 0.7)+
  theme_bw()

ggplot(dims_umap.small, aes(x = UMAP_1, y = UMAP_2, color = sequencing_tech))+
  geom_point(size = 1, alpha = 0.7)+
  scale_color_manual(values = c('#6600FF', '#33CC33', '#006600', '#FF6633'))+
  theme_bw()
```




#########################
# UMAP ON CLR TRANSFORM #
#########################

## FAMILY AGGLOMERATION
```{r}
# CLR-TRANSFORM DATA
physeq_fecal.clr <- microbiome::transform(physeq.fecal, "clr") # the function adds pseudocounts itself


# GET THE FAMILY TABLE
agg_fam_fecal.clr <- physeq_fecal.clr %>%
  tax_glom(taxrank = "Family") %>%
  psmelt()
familyTable_fecal.clr <- acast(agg_fam_fecal.clr, Sample ~ Family, value.var = 'Abundance')
# saveRDS(familyTable_fecal.clr, "~/Projects/IBS_Meta-analysis_16S/data/analysis-combined/02_UMAP/familyTable_fecal_clr.rds")

# RUN UMAP
set.seed(123)
umapFam_fecal.clr <- uwot::umap(familyTable_fecal.clr, # umap on samples (rows) and families abundances (columns)
                                n_neighbors=50, n_components=3, n_threads=8)
# saveRDS(umapFam_fecal.clr, "~/Projects/IBS_Meta-analysis_16S/data/analysis-combined/02_UMAP/umapFam_fecal_clr.rds")

# Add covariates
covariates_fecal <- data.frame(disease = sample_data(physeq_fecal.clr)[,'host_disease'],
                               subtype = sample_data(physeq_fecal.clr)[,'host_subtype'],
                               seq_tech = sample_data(physeq_fecal.clr)[,'sequencing_tech'],
                               author = sample_data(physeq_fecal.clr)[,'author'],
                               variable_region = sample_data(physeq_fecal.clr)[,'variable_region'],
                               age = sample_data(physeq_fecal.clr)[,'host_age'],
                               bmi = sample_data(physeq_fecal.clr)[,'host_bmi'])

# Get the (x,y) coordinates from the UMAP
dims.umapFam_fecal_clr <- umapFam_fecal.clr %>% as.data.frame()
colnames(dims.umapFam_fecal_clr) <- c("UMAP_1", "UMAP_2", "UMAP_3")
rownames(dims.umapFam_fecal_clr) <- rownames(familyTable_fecal.clr)
dims.umapFam_fecal_clr <- merge(as.data.frame(dims.umapFam_fecal_clr), covariates_fecal, by="row.names") # umap+covariates


# PLOT host_disease
ggplot(dims.umapFam_fecal_clr, aes(x = UMAP_1, y = UMAP_2, color = host_disease))+
  geom_point(size = 2, alpha = 0.7)+
  scale_color_manual(values = c('blue', 'red', 'black'))+
  labs(title = 'Agglomeration at Family level')+
  theme_bw()

# PLOT host_subtype
ggplot(dims.umapFam_fecal_clr, aes(x = UMAP_1, y = UMAP_2, color = host_subtype))+
  geom_point(size = 1, alpha = 0.7)+
  scale_color_manual(values = c('#99CCFF', '#FF3300', '#990000', '#FF66CC','#FFFF66', '#CCCCCC'))+
  labs(title = 'Agglomeration at Family level')+
  theme_bw()

# PLOT author
ggplot(dims.umapFam_fecal_clr, aes(x = UMAP_1, y = UMAP_2, color = author))+
  geom_point(size = 2, alpha = 0.7)+
  theme_bw()

# PLOT seqtech
ggplot(dims.umapFam_fecal_clr, aes(x = UMAP_1, y = UMAP_2, color = sequencing_tech))+
  geom_point(size = 2, alpha = 0.7)+
  scale_color_manual(values = c('#6600FF', '#33CC33', '#006600', '#FF6633'))+
  theme_bw()
plotly::plot_ly(dims.umapFam_fecal_clr, x=~UMAP_1, y=~UMAP_2, z=~UMAP_3, color=~host_subtype, type="scatter3d", mode="markers")
```




#########################
# UMAP ON HOST_SUBTYPE #
#########################

## FAMILY AGGLOMERATION
```{r}
# Get the list of samples with info on host_subtype
covariates.subtype <- covariates %>% filter(author %in% c("Labus", "LoPresti", "Liu", "Pozuelo", "Mars", "Zhuang", "Nagel", "Zeber-Lubecka"),
                                            host_subtype != "IBS-unspecified",
                                            Collection=="1st")
subtype.ratiosFam <- ratiosFam[rownames(ratiosFam) %in% rownames(covariates.subtype),]
dim(subtype.ratiosFam) # 553 samples

# Run UMAP
umapFam.subtype <- uwot::umap(subtype.ratiosFam, # umap on samples (rows) and families abundances (columns)
                              n_neighbors=10, n_components=3, n_threads=8)


# Get the (x,y) coordinates from the UMAP
dims.umapFam.subtype <- umapFam.subtype %>% as.data.frame()
colnames(dims.umapFam.subtype) <- c("UMAP_1", "UMAP_2", "UMAP_3")
rownames(dims.umapFam.subtype) <- rownames(subtype.ratiosFam)
dims.umapFam.subtype <- merge(as.data.frame(dims.umapFam.subtype), covariates.subtype, by="row.names") # umap+covariates


# PLOT host_disease
ggplot(dims.umapFam.subtype, aes(x = UMAP_1, y = UMAP_2, color = host_disease))+
  geom_point(size = 2, alpha = 0.7)+
  scale_color_manual(values = c('blue', 'red', 'black'))+
  labs(title = 'Agglomeration at Family level')+
  theme_bw()

# PLOT host_subtype
ggplot(dims.umapFam.subtype, aes(x = UMAP_1, y = UMAP_2, color = host_subtype))+
  geom_point(size = 2, alpha = 0.7)+
  #scale_color_manual(values = c('#99CCFF', '#FF3300', '#990000', '#FF66CC'))+
  labs(title = 'Agglomeration at Family level')+
  theme_bw()

# PLOT author
ggplot(dims.umapFam.subtype, aes(x = UMAP_1, y = UMAP_2, color = author))+
  geom_point(size = 2, alpha = 0.7)+
  theme_bw()

# PLOT seqtech
ggplot(dims.umapFam.subtype, aes(x = UMAP_1, y = UMAP_2, color = sequencing_tech))+
  geom_point(size = 2, alpha = 0.7)+
  scale_color_manual(values = c('#6600FF', '#33CC33', '#006600', '#FF6633'))+
  theme_bw()
plotly::plot_ly(dims.umapFam.subtype, x=~UMAP_1, y=~UMAP_2, z=~UMAP_3, color=~host_subtype, type="scatter3d", mode="markers")
```




#######################
# UMAP ON GENUS LEVEL #
#######################


```{r}
# IMPORT DATA
path <- "~/Projects/IBS_Meta-analysis_16S/data/analysis-combined/02_UMAP/data_logratio/"
df <- readRDS(file.path(path, "genus_agg.rds"))
df1 <- acast(df, Genus~Sample, fun.aggregate=sum, value.var = 'Abundance') # samples x genera (clr)

dims.umapGenus <- readRDS(file.path(path, "dims_umapGenus.rds")) # coordinates umap + covariates

author.order <- c('Labus', 'LoPresti', 'Ringel', # 454 pyrosequencing
                  'AGP', 'Liu', 'Pozuelo', # Illumina single end
                  'Fukui', 'Hugerth', 'Zhu', 'Zhuang', # Illumina paired end
                  'Nagel', 'Zeber-Lubecka') # Ion Torrent
dims.umapGenus$author <- factor(dims.umapGenus$author, levels=author.order)
colnames(dims.umapGenus)[1] <- "samples"

# Plot ggplot
ggplot(dims.umapGenus, aes(x = UMAP_1, y = UMAP_2, color = host_subtype))+
  geom_point(size = 1, alpha = 0.6)+
  #scale_color_manual(values=brewer.paired(n=13), name="")+ # author
  # scale_color_manual(values=c("blue", "red", "black"), name="")+ # host_disease
  # scale_color_manual(values=c('#6600FF', '#33CC33', '#006600', '#FF6633'))+ # seqtech
  scale_color_manual(values=c("#BDD7E7", "#D95F02", "#7570B3", "#E7298A", "#FEEDDE", "grey"))+
  theme(panel.grid = element_blank(),
        panel.background=element_blank())
ggsave("~/Projects/IBS_Meta-analysis_16S/data/analysis-combined/02_UMAP/umapGenus_subtype.jpg", width=6, height=3.5)

# Plot plotly
plotly::plot_ly() %>%
  add_trace(data=dims.umapGenus,
            x=~UMAP_1, y=~UMAP_2, z=~UMAP_3,
            color=~host_subtype,
            # colors=brewer.paired(n=13),
            # colors=c("blue", "red", "black"),
            #colors=c('#6600FF', '#33CC33', '#006600', '#FF6633'),
            type="scatter3d",
            mode="markers",
            marker=list(size=5))


# Add shannon diversity
p <- plot_richness(physeq.fecal, x="host_disease", measures="Shannon") +
  geom_boxplot(fill=NA, width=0.3) +
  facet_wrap(~author, scales="fixed") +
  theme_bw() +
  labs(x="", y="Shannon")
shannon <- p$data %>%
  select(samples, value) %>%
  rename(shannon=value)
test <- merge(dims.umapGenus, shannon, by="samples")

# Add simpson diversity
p <- plot_richness(physeq.fecal, x="host_disease", measures="Simpson") +
  geom_boxplot(fill=NA, width=0.3) +
  facet_wrap(~author, scales="fixed") +
  theme_bw() +
  labs(x="", y="Simpson")
simpson <- p$data %>%
  select(samples, value) %>%
  rename(simpson=value)
test <- merge(test, simpson, by="samples")

# Plot ggplot
ggplot(test, aes(x = UMAP_1, y = UMAP_2, color = simpson))+
  geom_point(size = 1, alpha = 1)+
  # scale_color_gradient2(midpoint = 0.9, low = "blue", mid = "white", high = "red") +
  # scale_colour_gradientn(colours = RColorBrewer::brewer.pal(10, "RdYlBu"))+
  theme(panel.grid = element_blank(),
        panel.background=element_blank())
ggsave("~/Projects/IBS_Meta-analysis_16S/data/analysis-combined/02_UMAP/umapGenus_shannon.jpg", width=6, height=3.5)


# Add log ratios phyla
test1 <- merge(dims.umapGenus, ratio.df, by=c("samples", "host_disease", "host_subtype", "sequencing_tech", "author"))
ggplot(test1, aes(x = UMAP_1, y = UMAP_2, color = LogRatio_FirmProt))+
  geom_point(size = 1, alpha = 1)+
  scale_color_gradient2(midpoint=mean(test1$LogRatio_FirmProt), low = "blue", mid = "white", high = "red") +
  # scale_colour_gradientn(colours = RColorBrewer::brewer.pal(10, "RdYlBu"))+
  theme(panel.grid = element_blank(),
        panel.background=element_blank())
ggsave("~/Projects/IBS_Meta-analysis_16S/data/analysis-combined/02_UMAP/umapGenus_firmact.jpg", width=6, height=3.5)

plotly::plot_ly() %>%
  add_trace(data=test1,
            x=~UMAP_1, y=~UMAP_2, z=~UMAP_3,
            color=~LogRatio_FirmBact,
            colors=brewer.rdbu(50),
            type="scatter3d",
            mode="markers",
            marker=list(size=5))

```




```{r sanity-checks-genus-numbers}
# Sanity checks
# With 0 counts
genus.agg <- physeq.fecal %>%
  tax_glom(taxrank = "Genus") %>%
  psmelt()

test <- genus.agg %>%
  filter(Abundance != 0) %>%
  group_by(Genus) %>%
  filter(n_distinct(author) == 1) %>%
  select(Genus, author, Abundance)
length(unique(test$Genus))
length(unique(genus.agg$Genus))
# 483 genera out of 976 are only in 1 dataset
unique.genera <- unique(test$Genus)
sum(genus.agg$Abundance)
sum(test$Abundance)
# represent 112,363 / 57,396,134

# With 0.5 counts
genus.agg2 <- readRDS(file.path(path, "genus_agg.rds"))
test2 <- genus.agg2 %>%
  filter(Genus %in% test$Genus) %>%
  group_by(Genus, author, Abundance) %>%
  select(Genus, author, Abundance)
length(unique(test2$Genus))
table(unique(test$Genus) %in% unique(test2$Genus))
# 483 genera
sum(genus.agg2$Abundance)
sum(test2$Abundance)



# FAMILY
# With 0 counts
family.agg <- physeq.fecal %>%
  tax_glom(taxrank = "Family") %>%
  psmelt()

fam0 <- family.agg %>%
  filter(Abundance != 0) %>%
  group_by(Family) %>%
  filter(n_distinct(author) == 1) %>%
  select(Family, author, Abundance)
length(unique(fam0$Family))
length(unique(family.agg$Family))
# 158 families out of 360 are only in 1 dataset
unique.families <- unique(fam0$Family)
sum(fam0$Abundance)
sum(family.agg$Abundance)
# represent 17,651 / 60,934,938

# With 0.5 counts
family.agg2 <- readRDS(file.path(path, "family_agg.rds"))
fam0_5 <- family.agg2 %>%
  filter(Family %in% fam0$Family) %>%
  group_by(Family, author, Abundance) %>%
  select(Family, author, Abundance)
length(unique(fam0_5$Family))
table(unique(fam0_5$Family) %in% unique(fam0_5$Family))
# 158 families
sum(fam0_5$Abundance)/sum(family.agg2$Abundance)


# NUMBER OF TAXA PER DATASET
genus.agg %>%
  filter(Abundance != 0) %>%
  select(Genus, author, Abundance) %>%
  group_by(author) %>%
  summarize(n_distinct(Genus), sum(Abundance)) %>%
  rename("nb_total-genus"="n_distinct(Genus)",
         "total_count" = "sum(Abundance)") %>%
  left_join(genus.agg %>%
                filter(Abundance != 0) %>%
                group_by(Genus) %>%
                filter(n_distinct(author) == 1) %>%
                ungroup() %>%
                select(Genus, author, Abundance) %>%
                group_by(author) %>%
                summarize(n_distinct(Genus), sum(Abundance)) %>%
                rename("nb_unique-genus"="n_distinct(Genus)", "total_count_unique_genus" = "sum(Abundance)"),
             by="author") %>%
  mutate("%total_counts" = (total_count_unique_genus*100)/total_count) %>%
  select(-c("total_count", "total_count_unique_genus"))

```

